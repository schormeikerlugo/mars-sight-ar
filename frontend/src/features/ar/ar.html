<div class="ar-container">
  <!-- AR Viewport (Camera/Scene) -->
  <div id="ar-view-space" class="ar-view-space">
    <!-- Three.js Canvas injected here -->
    <div id="reticle" class="reticle">
      <div class="reticle-ring inner"></div>
      <div class="reticle-ring mid"></div>
      <div class="reticle-ring outer"></div>
      <div class="scan-wave"></div>
    </div>

    <!-- Markers Container (3D Anchors) -->
    <div id="markers-container"></div>

    <!-- Marker Labels Layer (2D Overlay) -->
    <div
      id="labels-container"
      style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      "
    ></div>

    <!-- Object Detection Overlays -->
    <div id="detection-boxes-container">
      <div
        id="target-lock"
        style="
          display: none;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 200px;
          height: 200px;
          border: 2px solid #3fa8ff;
          border-radius: 10px;
          pointer-events: none;
          z-index: 10;
        "
      >
        <div
          id="target-label"
          style="
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #3fa8ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Jura';
            font-weight: bold;
            white-space: nowrap;
          "
        >
          TARGET
        </div>
      </div>
    </div>
  </div>

  <!-- UI Overlay Layer -->
  <div class="ar-ui-layer">
    <!-- Top Bar -->
    <div class="ar-top-bar">
      <div class="ar-top-left">
        <button id="btn-map" class="btn-map glass-panel">
          <img src="/icons/ar/map.svg" alt="Map" class="icon-btn" />
          <span>MAP</span>
        </button>
      </div>

      <div class="ar-compass-gps glass-panel">
        <div class="compass-strip-container">
          <div id="compass-strip" class="compass-strip">
            <!-- Infinite Strip Pattern: S W N E S W N E S W N E -->
            <!-- We repeat enough to allow seamless scrolling/looping -->
            <span>S</span><span>|</span><span>|</span> <span>W</span
            ><span>|</span><span>|</span> <span>N</span><span>|</span
            ><span>|</span> <span>E</span><span>|</span><span>|</span>
            <span>S</span><span>|</span><span>|</span> <span>W</span
            ><span>|</span><span>|</span> <span>N</span><span>|</span
            ><span>|</span> <span>E</span><span>|</span><span>|</span>
            <span>S</span><span>|</span><span>|</span> <span>W</span
            ><span>|</span><span>|</span> <span>N</span><span>|</span
            ><span>|</span>
            <span>E</span>
          </div>
          <div class="compass-indicator"></div>
        </div>
        <div class="gps-data">
          <span class="gps-label">LAT</span> <span id="gps-lat">--.------</span>
          <span class="gps-divider">|</span>
          <span class="gps-label">LNG</span> <span id="gps-lng">--.------</span>
          <span class="gps-divider">|</span>
          <span class="gps-label">HEAD</span> <span id="gps-head">--°</span>
        </div>
      </div>

      <div class="ar-top-right">
        <div class="server-status">
          <span class="status-dot"></span>
          <span>ONLINE</span>
        </div>
        <button id="btn-settings" class="btn-settings glass-panel">
          <img src="/icons/ar/Settings.svg" alt="Settings" class="icon-btn" />
          <span>SETTINGS</span>
        </button>
      </div>
    </div>

    <!-- Left Telemetry (Collapsible) -->
    <div class="ar-telemetry-container">
      <button
        id="btn-toggle-telemetry"
        class="btn-toggle-telemetry glass-panel"
      >
        <span>◂</span>
      </button>
      <div id="ar-telemetry" class="ar-telemetry glass-panel">
        <div class="telem-item">
          <span class="telem-val">20°C</span>
          <span class="telem-lbl">TEMP</span>
        </div>
        <div class="telem-item">
          <span class="telem-val">96%</span>
          <span class="telem-lbl">O2</span>
        </div>
        <div class="telem-item">
          <span class="telem-val">75</span>
          <span class="telem-lbl">BPM</span>
        </div>
        <div class="telem-item">
          <span class="telem-val">0.01</span>
          <span class="telem-lbl">RAD</span>
        </div>
      </div>
    </div>

    <!-- Bottom Controls -->
    <div class="ar-bottom-bar">
      <!-- AI Chat Button info -->
      <div class="ar-bottom-left">
        <button id="btn-ai-chat" class="btn-ai-chat glass-panel">
          <img src="/icons/ar/IA.svg" alt="AI" class="icon-btn" />
          <span>Llama 3.8</span>
        </button>
      </div>

      <!-- Action Buttons -->
      <div class="ar-bottom-right">
        <button id="btn-scan" class="btn-action glass-panel">SCAN</button>
        <button id="btn-teach" class="btn-action glass-panel">TEACH</button>
        <button id="btn-tick" class="btn-action glass-panel active">
          TICK
        </button>
      </div>
    </div>

    <!-- AI Chat Modal -->
    <div id="ai-chat-modal" class="modal-overlay" style="display: none">
      <div class="modal-content glass-panel">
        <div class="chat-header">
          <span><img src="/icons/ar/IA.svg" class="icon-btn" /> Llama 3.8</span>
          <button class="close-modal">✕</button>
        </div>
        <div class="chat-messages"></div>
        <div class="chat-input-area">
          <input type="text" placeholder="Ask AI..." />
          <button>Send</button>
        </div>
      </div>
    </div>

    <!-- Teach Modal -->
    <div id="teach-modal" class="modal-overlay" style="display: none">
      <div class="modal-content glass-panel">
        <div class="chat-header">
          <span>TEACH MODE</span>
          <button id="btn-teach-cancel" class="close-modal">✕</button>
        </div>
        <div style="padding: 20px; color: #fff">
          <label style="display: block; margin-bottom: 10px"
            >Label Object:</label
          >
          <input
            type="text"
            id="inp-teach-label"
            style="
              width: 100%;
              padding: 10px;
              margin-bottom: 20px;
              background: rgba(0, 0, 0, 0.5);
              border: 1px solid #3fa8ff;
              color: white;
            "
          />
          <button
            id="btn-teach-confirm"
            class="btn-action glass-panel"
            style="width: 100%"
          >
            LEARN
          </button>
        </div>
      </div>
    </div>

    <!-- Mark Modal (Manual Save) -->
    <div id="mark-modal" class="modal-overlay" style="display: none">
      <div class="modal-content glass-panel">
        <div class="chat-header">
          <span>GUARDAR MARCADOR</span>
          <button id="btn-mark-cancel" class="close-modal">✕</button>
        </div>
        <div style="padding: 20px; color: #fff">
          <label style="display: block; margin-bottom: 5px">Título:</label>
          <input
            type="text"
            id="inp-mark-title"
            placeholder="Ej: Base Alpha"
            style="
              width: 100%;
              padding: 10px;
              margin-bottom: 15px;
              background: rgba(0, 0, 0, 0.5);
              border: 1px solid #3fa8ff;
              color: white;
            "
          />

          <label style="display: block; margin-bottom: 5px"
            >Descripción (Opcional):</label
          >
          <textarea
            id="inp-mark-desc"
            placeholder="Detalles..."
            style="
              width: 100%;
              height: 60px;
              padding: 10px;
              margin-bottom: 20px;
              background: rgba(0, 0, 0, 0.5);
              border: 1px solid #3fa8ff;
              color: white;
            "
          ></textarea>

          <button
            id="btn-mark-confirm"
            class="btn-action glass-panel active"
            style="width: 100%"
          >
            GUARDAR PUNTO
          </button>
        </div>
      </div>
    </div>

    <!-- Description Modal -->
    <div id="description-modal" class="modal-overlay" style="display: none">
      <div class="modal-content glass-panel">
        <div class="chat-header">
          <span>OBJECT INFO</span>
          <button id="btn-description-close" class="close-modal">✕</button>
        </div>
        <div
          id="description-content"
          style="padding: 20px; color: #ccc; line-height: 1.5; overflow-y: auto"
        >
          <!-- Dynamic content -->
        </div>
      </div>
    </div>

    <!-- Settings Panel (Transparent for 3D View) -->
    <div
      id="settings-panel"
      class="settings-modal-overlay"
      style="display: none"
    >
      <div
        class="modal-content glass-panel"
        style="
          background: rgba(17, 17, 17, 0.95);
          backdrop-filter: blur(15px);
          margin-top: 80px;
          max-height: 70vh;
        "
      >
        <div class="chat-header">
          <span>SYSTEM CONFIG</span>
          <button class="close-modal" id="btn-close-settings">✕</button>
        </div>
        <div
          style="
            padding: 10px;
            color: #fff;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
          "
        >
          <!-- 0. MISSION CONTROL -->
          <div
            class="setting-group"
            style="
              border: 1px solid #0055aa;
              background: rgba(0, 20, 40, 0.5);
              padding: 15px;
              border-radius: 8px;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <label
                style="
                  display: block;
                  font-weight: bold;
                  color: #00aaff;
                  margin: 0;
                "
                >ESTADO DE MISIÓN</label
              >
              <span
                id="mission-status-badge"
                style="
                  background: #555;
                  padding: 2px 6px;
                  border-radius: 4px;
                  font-size: 0.7rem;
                "
                >INACTIVA</span
              >
            </div>

            <!-- START INTERFACE REMOVED (Managed via Dashboard) -->

            <!-- ACTIVE INTERFACE -->
            <div id="mission-active-ui" style="margin-top: 10px; display: none">
              <div
                style="
                  font-size: 0.8rem;
                  margin-bottom: 8px;
                  color: #ccc;
                  text-align: center;
                "
              >
                Registrando datos...
              </div>
              <button id="btn-end-mission" class="btn-end-mission">
                FINALIZAR MISIÓN
              </button>
            </div>
          </div>
          <!-- 1. AI Control -->
          <div
            class="setting-group"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div>
              <label style="display: block; font-weight: bold"
                >AI SCANNER</label
              >
              <span style="font-size: 0.7rem; color: #aaa"
                >Reconocimiento de Objetos</span
              >
            </div>
            <button id="btn-ai-toggle" class="toggle-btn active">ON</button>
          </div>

          <!-- 1.5 Sentinel Mode -->
          <div
            class="setting-group"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div>
              <label style="display: block; font-weight: bold; color: #ff4444"
                >MODO CENTINELA</label
              >
              <span style="font-size: 0.7rem; color: #aaa"
                >Vigilancia y Registro Automático</span
              >
            </div>
            <button id="btn-sentinel-toggle" class="toggle-btn">OFF</button>
          </div>

          <!-- 1.6 Auto-Save Detections (NEW) -->
          <div
            class="setting-group"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              background: rgba(0, 80, 0, 0.2);
              padding: 12px;
              border-radius: 8px;
              border: 1px solid #00aa00;
            "
          >
            <div>
              <label style="display: block; font-weight: bold; color: #00ff00"
                >AUTO-GUARDAR</label
              >
              <span style="font-size: 0.7rem; color: #aaa"
                >Guardar detecciones automáticamente</span
              >
            </div>
            <button id="btn-autosave-toggle" class="toggle-btn">OFF</button>
          </div>

          <!-- 2. Search Radius (My Idea) -->
          <div class="setting-group">
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
              "
            >
              <label style="font-weight: bold">RADIO DE VISIÓN</label>
              <span id="lbl-radius" style="color: #3fa8ff">1000m</span>
            </div>
            <input
              type="range"
              id="inp-radius"
              min="100"
              max="5000"
              step="100"
              value="1000"
            />
          </div>

          <!-- 3. Calibration Trigger -->
          <div class="setting-group">
            <label style="display: block; font-weight: bold; margin-bottom: 5px"
              >BRÚJULA</label
            >
            <button
              id="btn-start-calibration"
              class="btn-action glass-panel"
              style="
                width: 100%;
                height: 50px;
                border-color: orange;
                color: orange;
              "
            >
              <img
                src="/icons/ar/map.svg"
                style="width: 20px; filter: sepia(1)"
              />
              CALIBRAR VISTA
            </button>
            <div style="font-size: 0.7rem; color: #aaa; margin-top: 5px">
              Abre herramienta de ajuste manual.
            </div>
          </div>

          <!-- 4. Visual Enhancements -->
          <div
            class="setting-group"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div>
              <label style="display: block; font-weight: bold"
                >GRILLA TÁCTICA</label
              >
              <span style="font-size: 0.7rem; color: #aaa"
                >Superposición de escáner</span
              >
            </div>
            <button id="toggle-grid" class="toggle-btn active">ON</button>
          </div>

          <div
            class="setting-group"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div>
              <label style="display: block; font-weight: bold"
                >CÁMARA REAL</label
              >
              <span style="font-size: 0.7rem; color: #aaa"
                >Feed de video en vivo</span
              >
            </div>
            <button id="toggle-camera" class="toggle-btn active">ON</button>
          </div>

          <div
            class="setting-group"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div>
              <label style="display: block; font-weight: bold"
                >INTERFAZ (HUD)</label
              >
              <span style="font-size: 0.7rem; color: #aaa"
                >Ocultar controles para inmersión</span
              >
            </div>
            <button id="toggle-ui" class="toggle-btn active">ON</button>
          </div>

          <div style="height: 1px; background: rgba(255, 255, 255, 0.1)"></div>

          <button
            id="btn-exit"
            class="btn-action glass-panel"
            style="width: 100%; border-color: red; color: red"
          >
            ABORT MISSION
          </button>
        </div>
      </div>
    </div>

    <!-- CALIBRATION HUD (Overlay for Manual Adjust) -->
    <div id="calibration-hud" class="calibration-hud" style="display: none">
      <div class="calibration-label">CALIBRANDO CÁMARA</div>
      <div style="color: #ccc; font-size: 0.8rem; text-align: center">
        Desliza hasta alinear el Norte (N) con el mundo real
      </div>

      <div class="calibration-slider-container">
        <span style="color: #888">L</span>
        <input
          type="range"
          id="inp-calibration"
          min="-180"
          max="180"
          value="0"
        />
        <span style="color: #888">R</span>
      </div>

      <div
        id="calibration-value"
        style="color: #3fa8ff; font-family: monospace"
      >
        OFFSET: 0°
      </div>

      <button
        id="btn-confirm-calibration"
        class="btn-action glass-panel active"
        style="width: 200px; margin-top: 10px"
      >
        CONFIRMAR
      </button>
    </div>
  </div>

  <!-- Detection Alert -->
  <div id="detection-alert" class="detection-alert" style="display: none">
    Scanner Active
  </div>
</div>
